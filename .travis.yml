language: generic
sudo: required
dist: trusty
before_install:
- sudo apt-get -qq update && sudo apt-get install -y --no-install-recommends publican libxml2-utils

notifications:
  email: false

matrix:
  include:
  - env: LANG="es-ES" MAKE_TARGET_SUFFIX="es"

script:
  - xmllint --postvalid --noout ${LANG}/Chapter*.xml
  - make pdf-${MAKE_TARGET_SUFFIX}
  - make html-${MAKE_TARGET_SUFFIX}
  # No idea how pdf name has been generated!
  - OUTPUT_PDF_NAME="$(cd tmp/${LANG}/pdf/; ls *.pdf)"
  - OUTPUT_NAME="${OUTPUT_PDF_NAME%.pdf}"
  - mv tmp/${LANG}/pdf/${OUTPUT_NAME}.pdf ${OUTPUT_NAME}.pdf;
  - "(cd tmp/${LANG}; zip ${OUTPUT_NAME}.zip -r html)"
  - "(cd tmp/${LANG}; tar cvzpf ${OUTPUT_NAME}.tgz html/)"
  - mv tmp/${LANG}/${OUTPUT_NAME}.{zip,tgz} .

deploy:
  skip_cleanup: True
  provider: releases
  draft: True
  api_key:
    secure: NOmz9mQ5yjaeN+KZVWBBmzmRFxZyQGsEfdcxYMKw6UW5YL7/NzRDnaQEDQcPTRqtcOa9xTwJySTDsMl88EhVCRBJnm2dqvi7Sfgsjy0IR4m6izStIxoWeXDqvV/uDUpYULYpCDMgn8kgFxVRD8o2aDqYUEyTyOhyqm0/uPC+hFKZ0K9BAuc88ZPp39gOkNfI8nBudunL94u1/m+04/lzHW+3Qk+RI9rqRteMaWnKzJtYQD/l+aH6CyryYtvEnQcX8nrmOY9ytLqGhHvaEy3P0OXB7smcPxSMQ+/SK4S6mwJwYg9LKNGuzTf7DoFwHOR+2c1ElFcPsdk7FEZcZxpAZUEtj/vhM79GKH/q57Veg/L9nrxcZm8nRJuWI8hoAA2RFCzfWFWPQ4Y4Cqn2J4YOJPZ5ghUVsWyb0QFKCht1itPxDfggxGRutx6weLN+mBtpppzSlhyEcsQ5FVpsAMGBDIFELde4HMWIRWEFB8ZCXg19QUKA3pJ8YgMAI/e2cSM0eEF57MnVXXbovXy656dpUM1AA0ZwvIYY0Ag0it8Ezg/lDnAN95XYQwVsDiA6LzqC8iFpF1Ms5Q3Se7YcuwkHYvfhORi6b6GMSmsAweVjWhDIFoum6Dd4kmsbFeNdL9W05GtFa2kP1j03cGJDIF5lMNZCnYtFSHo3nymfXNU0C5Q=
  file:
  - ${OUTPUT_NAME}.pdf
  - ${OUTPUT_NAME}.zip
  - ${OUTPUT_NAME}.tgz
  on:
    tag: True
