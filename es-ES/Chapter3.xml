<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % BOOK_ENTITIES SYSTEM "manual.ent">
<!ENTITY PRODUCT "Documentation">
<!ENTITY BOOKID "manual">
<!ENTITY YEAR "2016">
<!ENTITY HOLDER "Eneo Tecnología S.L. |">
]>
<chapter>
	<title>Configuraciones del Manager postinstalación</title>
	<para>Al finalizar la instalación del Manager, es necesario realizar de manera "manual" una serie de configuraciones postinstalación que son necesarias para el correcto funcionamiento del Manager y la comunicación con cada uno de los sensores.</para>
	<para>Algunas de estas configuraciones se pueden realizar directamente desde la plataforma web redBorder, otras, sin embargo, deberán llevarse a cabo mediante la ejecución de comandos en la terminal de su máquina. </para>
	<para>Estos son los procedimientos postinstalación que vamos a abordar en este capítulo:</para>
	<itemizedlist mark="bullet">
		<listitem>
			<para>Activación de servicios de Malware:</para>
			<para>-Activación de los cargadores</para>
			<para>-Gestión básica de máquinas virtuales para Cuckoo Sandbox</para>
		</listitem>
	</itemizedlist>
	<para>Vamos a realizar un repaso rápido sobre la estructura y navegación dentro de la plataforma web redBorder que permitirá que el usuario pueda moverse con facilidad por ella para realizar algunos de estos ajustes básicos <footnote><para> Algunas configuraciones básicas tras el registro de los sensores IPS/IDS como Mail Gateway se realizarán desde la plataforma web redBorder. Consultar los capítulos correspondientes al registro de cada uno de los sensores para redBorder Malware.</para></footnote>. En un capítulo posterior se abordarán todas las opciones, menús y sobmenús contenidos en la plataforma de una manera más avanzada. </para>
	<section>
		<title>Estructura de la interfaz de la plataforma redBorder</title>
		<para>Existe una estructura que se repite en todas las interfaces de plataforma web redBorder. Conocer estos elementos le ayudará a navegar por la web de un modo cómodo y sencillo. <footnote><para>La imagen adjunta corresponde a una instalación de redBorder con las Apps Flow, IPS y Malware activas. La estructura será la misma para cualquier instalación de redBorder que se realice, variando únicamente las Apps disponibles en la barra del menú superior, según hayan sido o no activadas.</para></footnote></para>
        <itemizedlist mark="bullet">
			<listitem>
				<para><emphasis role="bold">Barra de menú:</emphasis> en ella encontrará el acceso directo a todas las secciones de la plataforma redBorder. Se encuentra subdividida en dos áreas diferenciadas según operatividad:</para>
				<para><emphasis>a) Área de analítica (margen superior izquierdo):</emphasis> en esta zona encontrará todos los datos recogidos por los sensores mostrados en diferentes métricas e informes.</para>
				<para><emphasis>b) Área de configuración (margen superior derecho):</emphasis> opciones de configuración y gestión de las Apps y la plataforma redBorder.</para>
				<mediaobject>
					<imageobject>
						<imagedata scalefit="1" align="center" width="450" fileref="images/ch03_img001.png"/>
					</imageobject>
					<caption>
						<para>Detalle de la barra de menú: área de análisis</para>
					</caption>
				</mediaobject>
				<mediaobject>
					<imageobject>
						<imagedata scale="60" align="center" fileref="images/ch03_img002.png"/>
					</imageobject>
					<caption>
						<para>Detalle de la barra de menú: área de configuración</para>
					</caption>
				</mediaobject>
			</listitem>
			<listitem>
				<para><emphasis role="bold">Submenú:</emphasis> muestra las opciones disponibles según la sección que nos encontremos consultando.</para>
			</listitem>
			<listitem>
				<para><emphasis role="bold">Área principal:</emphasis> contenido de la sección en la que nos encontremos. En esta zona se muestran los datos en diferentes métricas y gráficas completamente personalizables. </para>
				<para><emphasis>-Resumen:</emphasis> bajo la gráfica se encuentra un resumen de la información mostrada en la métrica, ofreciendo los valores totales.</para>
				<para><emphasis>-Buscador:</emphasis> permite buscar rápidamente en la tabla de datos cualquier elemento relacionado con el atributo que se está consultando. Para ello basta con introducir la IP, sensor, cliente, etc. que se quiera consultar. Además, las búsquedas pueden convertirse en filtros tal y como veremos más adelante.</para>
				<para><emphasis>-Tabla de datos:</emphasis> ofrece el detalle de la información que se muestra en la métrica. Además, se pueden realizar diferentes acciones por filas. Estas acciones dependerán de la pestaña/App que estemos consultando.</para>
			</listitem>
		</itemizedlist>
	</section>
	<section>
		<title>Activación de servicios de Malware</title>	
		<para>Para asegurar el correcto funcionamiento del Manager en modo Malware y la comunicación con los sensores debemos llevar a cabo una serie de configuraciones postinstalación que incluyen el levantamiento del servidor. Los siguientes pasos que aquí se explican deberán realizarse desde la terminal de la máquina a la que nos habremos conectado previamente mediante conexión SSH.</para>
		<para>El procedimiento de activación de los servicios consta de tres pasos:</para>	
		<orderedlist numeration="arabic">
			<listitem>
				<para><emphasis role="bold">Configuración de los servicios</emphasis></para>
				<para>-Configuración de Hadoop</para>
				<para>-Configuración de complementos de Hadoop</para>
				<para>-Configuración de complementos de Druid</para>
				<para>-Activación de cargadores</para>
				<para>-Configuración de Oozie</para>
			</listitem>
			<listitem>
				<para><emphasis role="bold">Indicar mensajes a procesar</emphasis></para>
			</listitem>
			<listitem>
				<para><emphasis role="bold">Ejecución de los servicios</emphasis></para>
			</listitem>
		</orderedlist>
		<section>
			<title>Configuración de los servicios</title>
			<para>Para la configuración de los servicios es necesario ejecutar el comando <literal>rb_set_service.rb:</literal> indicando el servicio y la acción (activación/desactivación) que queremos realizar.</para>
			<note>
				<title>Nota</title>
				<para>0=desactivar/1=activar</para>
				<para>enable=activar/disable=desactivar</para>
			</note>
			<para>Una vez que se haya indicado qué servicios deseamos activar o desactivar, será necesario en cada paso, el levantamiento de Chef para aplicar la configuración mediante mediante el comando <screen>rb_wakeup_chef -cl</screen>.</para>
			<para><emphasis role="bold">Configuración de Hadoop</emphasis></para>
			<para>El primer paso que debemos realizar es la configuración de Hadoop, para lo que deberemos activar algunos de los servicios mediante la ejecución del comando <literal>rb_set_service.rb:</literal></para>
			<para>A continuación se indican los servicios que se deben activar:</para>
			<para><screen>rb_set_service.rb hadoop_resourcemanager:1 hadoop_nodemanager:1 hadoop_namenode:1 hadoop_datanode:1</screen></para>
			<para>Levantar Chef con el comando: <screen>rb_wakeup_chef -cl</screen></para>
			<para><emphasis role="bold">Configuración de complementos de Hadoop</emphasis></para>
			<para>Una vez que se han ejecutado los anteriores comandos y se ha procedido al levantamiento del servidor debemos activar los complementos de Hadoop (Oozie y Aerospike) medainte el comando <literal>rb_set_service.rb:</literal></para>
			<para><screen>rb_set_service.rb oozie:1 aerospike:1</screen></para>
			<para>Levantar el servidor con el comando: <screen>rb_wakeup_chef -cl</screen></para>
			<para><emphasis role="bold">Configurar Druid</emphasis></para>
			<para>En este punto vamos a proceder a la activación de los servicios de Druid. Es importante que el servicio <literal>realtime</literal> se desactive, ya que por defecto, se encuentra habilitado:</para>
			<para><screen>rb_set_service.rb druid_realtime:0 druid_overlord:1 druid_middleManager:1</screen></para>	
			<para>Levantar el servidor con el comando: <screen>rb_wakeup_chef -cl</screen></para>
			<para>Antes de realizar la activación de <literal>rb-sequence-oozie</literal> se debe proceder a un paso intermedio: activación de los cargadores.</para>
			<section>
				<title>Activación de los cargadores</title>
				<para>Los cargadores son bloques encargados de procesar archivos que están íntimamente relacionados con el procesado de datos y el motor de detección de Malware.</para>
				<para><emphasis role="bold">Cargadores disponibles</emphasis></para>
				<para>A continuación se describen cada uno de los cargadores que se encuentran disponibles:</para>
				<itemizedlist mark="bullet">
					<listitem>
						<para><emphasis role="bold">VirusTotal</emphasis></para>
						<para>Cargador que se encarga de enviar el SHA256 del archivo a la API de VirusTotal. Una vez que VirusTotal devuelve el resultado, el cargador lo captura y envía los resultados a Kafka. 
						Es necesario el uso de una API-key que se introduce en el archivo <literal>/opt/rb/var/chef/cookbooks/redBorder-manager/templates/default/rb-sequence-oozie_config.yml.erb</literal> y que quedará configurada en <literal>/opt/rb/var/rb-sequence-oozie/config/config.yml.</literal></para>
					</listitem>
					<listitem>
						<para><emphasis role="bold">Metascan</emphasis></para>
						<para>Cargador que se encarga de enviar el SHA256 del archivo a la API de Metascan. Una vez que Metascan devuelve el resultado, el cargador lo captura y envía los resultados a Kafka. 
						Es necesario el uso de una API-key que se introduce en el archivo <literal>/opt/rb/var/chef/cookbooks/redBorder-manager/templates/default/rb-sequence-oozie_config.yml.erb</literal> y que quedará configurada en <literal>/opt/rb/var/rb-sequence-oozie/config/config.yml.</literal></para>
					</listitem>
					<listitem>
						<para><emphasis role="bold">Clamscan</emphasis></para>
						<para>Cargador que envía el archivo localmente al servicio de ClamAV para que sea analizado. Una vez finalizado el análisis se captura la salida y se envía a Kafka. </para>
					</listitem>
					<listitem>
						<para><emphasis role="bold">Hasher</emphasis></para>
						<para>Cargador que se encarga de calcular los fuzzy hashes de los archivos. El resultado se captura y se almacena en Hadoop HDFS. La ruta HDFS de los hashes es <literal>/user/oozie/fuzzy/</literal></para>
					</listitem>
					<listitem>
						<para><emphasis role="bold">Kaspersky</emphasis></para>
						<para>Cargador que se encarga de lanzar el análisis local a través de Kaspersky. Kaspersky debe estar instalado en la máquina. Una vez que finaliza el análisis se captura el resultado y se envía a Kafka.</para>
					</listitem>
					<listitem>
						<para><emphasis role="bold">Cuckoo</emphasis></para>
						<para>Cargador que se encarga de subir el archivo a las máquinas de Cuckoo. El cargador enviará cada archivo a cada máquina diferente de Cuckoo (Por ejemplo: Windows 32bit y Windows 64bit) para que sea analizado por todas ellas. El cargador no espera a la finalización del mismo para no dejar bloqueado el análisis. Una vez que Cuckoo finaliza almacena los resultados en Hadoop. </para>
					</listitem>
				</itemizedlist>
				<para><emphasis role="bold">Procedimiento de activación de los cargadores</emphasis></para>
				<note>
					<title>Nota</title>
					<para>Cada vez que se realice un cambio en Chef es necesario realizar la subida de los cambios a Chef y el levantamiento del servidor mediante los siguientes comandos:</para>
					<para><literal>rb_upload_cookbooks.sh manager</literal></para>
					<para><literal>rb_wakeup_chef -cl </literal></para>
				</note>
				<orderedlist numeration="arabic">
					<listitem>
						<para><emphasis>Extraer ficheros de cargadores y subir a Chef</emphasis></para>
						<para>Para iniciar el procedimiento de activación de los cargadores, lo primero que debemos hacer es abrir el archivo de atributos de Chef para seleccionar aquellos cargadores que deseamos activar en 
						<literal>/opt/rb/var/chef/cookbooks/redBorder-manager/attributes/default.rb </literal></para>
						<para>Definir los cargadores a utilizar: Hasher, Clamscan, Virustotal, Metascan y Virustotal (borrar el resto de cargadores que no se desean usar):</para>
						<para><screen>default["redBorder"]["manager"]["rb-sequence-oozie"]["loaders"][ "hasher","clamscan","virustotal","metascan","cuckoo" ]</screen></para>
						<para>Por último, se realiza la subida de los cambios y levantamos Chef mediante los siguientes comandos:</para>
						<para><screen>rb_upload_cookbooks.sh manager</screen></para>
						<para><screen>rb_wakeup_chef -cl</screen></para>
						<para>En este punto, Chef se configura y modifica el archivo (<literal> /opt/rb/var/rb-sequence-oozie/conf/config.yml </literal>), a continuación hace un reload automático de la aplicación.</para>
					</listitem>
					<listitem>
						<para><emphasis>Configuración de las API Keys</emphasis></para>
						<para>El siguiente paso es introducir las claves (API Keys) para los cargadores Virustotal y Metascan. La obtención de dichas claves se realiza mediante registro previo en <emphasis role="bold">https://www.opswat.com/</emphasis> y <emphasis role="bold">https://www.virustotal.com/es/documentation/private-api/</emphasis></para>
						<para>El usuario debe insertar las claves en el archivo <literal>/opt/rb/var/chef/cookbooks/redBorder-manager/templates/default/rb-sequence-oozie_config.yml.erb </literal> en los espacios habilitados para ello. </para>
						<para>A continuación, y para finalizar el proceso, se suben los cambios y se levanta Chef para que la nueva configuración quede cargada:</para>
						<para><screen>rb_upload_cookbooks.sh manager</screen></para>
						<para><screen>rb_wakeup_chef -cl</screen></para>
						<mediaobject>
							<imageobject>
								<imagedata scalefit="1" align="center" width="450" fileref="images/ch03_img003.png"/>
							</imageobject>
							<caption>
								<para>Activación de los cargadores: Configuración de las API Keys</para>
							</caption>
						</mediaobject>
					</listitem>
				</orderedlist>
				<para>Con este último paso se da por finalizada la activación de los cargadores.</para>
				<para>En este punto ya podemos proceder a la configuración de rb-sequence-oozie.</para>
				<para><emphasis role="bold">Configuración de rb-sequence-oozie</emphasis></para>
				<para>Una vez que los cargadores se han activado, podemos proceder a la configuración de la aplicación <literal>rb-sequence-oozie</literal> 
				que es la encargada de obtener los ficheros S3, escribirlos en Hadoop y ejecutar los trabajos de análisis a través del servicio Oozie.</para>
				<para><screen>rb_set_service.rb rb-sequence-oozie:1</screen></para>
				<para><screen>rb_wakeup_chef -cl</screen></para>
				<para><screen>/etc/init.d/rb-sequence-oozie reload</screen></para>
				<para>La finalización del proceso puede tardar unos minutos, una vez que se ha completado, los servicios han quedado habilitados.</para>
			</section>
		</section>
		<section>
			<title>Indicar mensajes a procesar</title>
			<para>Una vez que se ha finalizado el proceso de configuración de los servicios debemos indicar qué tipo de mensajes deberá procesar el Manager dependiendo del sensor o sensores que se vayan a registrar. Para ello se usará el comando <literal>rb_set_topic.rb</literal></para>
			<important>
				<title>Importante</title>
				<para>Los mensajes correspondientes a Malware siempre deben ser indicados como topic. El resto dependerán del tipo de sensores a registrar en el Manager.</para>
			</important>
			<para>Para esta release deberemos activar el procesado de los mensajes para IPS <literal>(rb_event)</literal> y Mail Gateway <literal>(rb_mail)</literal>:</para>
			<para><screen>rb_set_topic.rb rb_malware:samza  rb_event:samza  rb_mail:samza</screen></para>
			<para>Recuerde que para que los cambios se realicen es necesario levantar Chef:</para>
			<para><screen>rb_wakeup_chef -cl</screen></para>
		</section>
		<section>
			<title>Ejecución de los servicios</title>
			<para>El último paso que garantiza la correcta activación de los servicios de Malware  en el Manager es la ejecución de la aplicación de cada uno de los servicios mediante los siguientes comandos. Una vez introducidos, podemos dar por finalizada la activación de los servicios.</para>
			<para><screen>rb_samza.sh -t enrichment -e</screen></para>
			<para><screen>rb_samza.sh -t indexing -e</screen></para>
			<para><screen>rb_samza.sh -t malware -e</screen></para>
		</section>
	</section>	
	<section>
		<title>Gestión básica de máquinas virtuales para Cuckoo Sandbox</title>
		<para>La gestión básica de las máquinas virtuales para Cuckoo Sandbox se realiza desde la plataforma web redBorder. Puede acceder a ella insertando en la barra de direcciones de su navegador la IP de gestión asignada al Manager.</para>
		<para><screen>https://direccion-IP-manager</screen></para>
		<mediaobject>
			<imageobject>
				<imagedata scalefit="1" align="center" width="450" fileref="images/ch03_img004.png"/>
			</imageobject>
			<textobject>
				<phrase>Pantalla de acceso a la plataforma redBorder: username y password</phrase>
			</textobject>
			<caption>
				<para>Pantalla de acceso a la plataforma redBorder: username y password</para>
			</caption>
		</mediaobject>
		<note>
			<title>Nota</title>
			<para>Es posible iniciar sesión en la plataforma usando la cuenta definida por defecto: <emphasis role="bold">admin o admin@redborder.net</emphasis> y con la contraseña que haya insertado en el proceso de instalación del Manager.</para>
			<para>La plataforma redBorder no funcionará si se intenta acceder a ella mediante web no cifrada.</para>
		</note>
		<para>El primer paso para la gestión de las máquinas virtuales para Cuckoo es realizar el <emphasis role="bold">alta de un nuevo disco de máquina virtual,</emphasis> a partir del cual, se creará una nueva máquina en el motor de virtualización KVM. Para ello se deben cumplir una serie de requisitos previos.</para>
		<para><emphasis role="bold">Requisitos previos para el alta de un nuevo disco de máquina virtual</emphasis></para>
		<itemizedlist mark="bullet">
			<listitem>
				<para><emphasis>Formato de las máquinas:</emphasis> El formato de las máquinas debe ser QCOW2. Este es el formato de KVM para el que se permite la realización de snapshots.</para>
			</listitem>
			<listitem>
				<para><emphasis>Configuración de las máquinas:</emphasis> Las máquinas deben estar previamente configuradas antes de darlas de alta. Cuckoo hace uso de un agente para comunicarse con las máquinas que utiliza para los análisis. Desde redBorder se proporcionan algunas máquinas ya preparadas.</para>
			</listitem>
			<listitem>
				<para><emphasis>Mantener la sesión activa:</emphasis> Antes de cargar las máquinas, se debe de asegurar que se ha hecho login en la plataforma redBorder con la opción “Remember me” o "Recordarme" activada. De este modo se evita que caduque la sesión del usuario mientras se está subiendo el archivo.</para>
			</listitem>
		</itemizedlist>
		<para>Una vez que hemos ingresado en la plataforma web redBorder nos dirigimos al la barra de menú a la zona de configuración donde encontraremos la opción <literal>Tools</literal> y en el submenú desplegable seleccionamos <literal>VMs Cuckoo.</literal></para>
		<mediaobject>
			<imageobject>
				<imagedata scalefit="1" align="center" width="450" fileref="images/ch03_img005.png"/>
			</imageobject>
			<caption>
				<para> Interfaz de gestión de VMs de Cuckoo</para>
			</caption>
		</mediaobject>
		<para>En esta interfaz nos encontraremos un listado que contiene todas las máquinas virtuales de Cuckoo que hayamos dado de alta. En el menú superior derecha se encuentra la opción <literal>+Add VM</literal> que permite dar de alta una nueva máquina.</para>
		<mediaobject>
			<imageobject>
				<imagedata scalefit="1" align="center" width="450" fileref="images/ch03_img006.png"/>
			</imageobject>
			<caption>
				<para>Interfaz de de VMs de Cuckoo: dar de alta una nueva máquina virtual</para>
			</caption>
		</mediaobject>
		<para>A continuación, visaulizamos una ventana emergente en a que se solicita el nombre de la máquina virtual en el campo <literal>Label.</literal> Asimismo, se solicitará el archivo que contiene la ISO y que deberá subirse dese una ubicación local.</para>
		<mediaobject>
			<imageobject>
				<imagedata scalefit="1" align="center" width="450" fileref="images/ch03_img007.png"/>
			</imageobject>
			<caption>
				<para>Añadir una nueva máquina virtual: formulario de alta de una nueva VM</para>
			</caption>
		</mediaobject>
		<para>Pulsar el botón <literal>Create</literal> para dar comienzo a la subida de la nueva máquina virtual. Dependiendo del tamaño de la máquina virtual, este proceso puede tardar varios minutos. Por este motivo, la máquina es enviada al servidor creándose un trabajo en segundo plano que realiza la configuración de Cuckoo para que use esta nueva máquina virtual. Puede consultar el proceso del trabajo en la opción <literal>Tools>Worker and Job Queue.</literal></para>
		<mediaobject>
			<imageobject>
				<imagedata scalefit="1" align="center" width="450" fileref="images/ch03_img008.png"/>
			</imageobject>
			<caption>
				<para>Añadir una nueva máquina virtual: consulta de Tools>Worker and Job Queue para comprobar la subida de la nueva máquina virtual</para>
			</caption>
		</mediaobject>
		<para>Una vez que el trabajo haya finalizado, este se mostrará en el listado <literal>Stored jobs</literal> en el que podremos comprobar si la máquina ha sido subida de manera satisfactoria.</para>
		<mediaobject>
			<imageobject>
				<imagedata scalefit="1" align="center" width="450" fileref="images/ch03_img009.png"/>
			</imageobject>
			<caption>
				<para>Añadir una nueva máquina virtual: consulta de Job Queue/Stored Jobs para comprobar que se ha finalizado el proceso de subida de la máquina virtual</para>
			</caption>
		</mediaobject>
		<para>Una vez ha finalizado este proceso, la nueva máquina virtual aparecerá en el listado que se muestra al consultar la interfaz la opción <literal>Tools>VMs Cuckoo</literal> tal y como se muetsra en la siguiente imagen:</para>
		<mediaobject>
			<imageobject>
				<imagedata scalefit="1" align="center" width="450" fileref="images/ch03_img010.png"/>
			</imageobject>
			<caption>
				<para>Interfaz de gestión de VMs de Cuckoo: nueva máquina virtual añadida</para>
			</caption>
		</mediaobject>
	</section>  	
</chapter>
